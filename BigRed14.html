<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Red Score Tracker</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="data:application/manifest+json,{
        'name': 'Big Mike's Big Red Tabulator',
        'short_name': 'BigRed',
        'start_url': '.',
        'display': 'standalone',
        'background_color': '#ff0000',
        'theme_color': '#ff0000',
        'icons': [{'src': 'https://via.placeholder.com/192x192.png?text=üÉè', 'sizes': '192x192', 'type': 'image/png'}]
    }">
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f9f9f9; color: #333; max-width: 600px; margin: auto; line-height: 1.5; min-height: 100vh; }
        h1 { text-align: center; color: #d00; margin: 10px 0 5px; font-size: 24px; font-weight: bold; }
        .subtitle { text-align: center; font-size: 16px; color: #666; margin-bottom: 20px; font-style: italic; }
        h2 { color: #333; font-size: 20px; margin: 20px 0 10px; }
        input, select { padding: 14px; margin: 12px 0; width: 100%; font-size: 18px; box-sizing: border-box; border-radius: 8px; border: 1px solid #ccc; background: white; }
        button { padding: 14px; margin: 12px 0; width: 100%; font-size: 18px; box-sizing: border-box; border-radius: 8px; border: none; font-weight: bold; min-height: 56px; color: white; cursor: pointer; }
        button:disabled { background: #aaa; cursor: not-allowed; }
        button.undo { background: #888; }
        .player-management { display: flex; gap: 12px; margin: 12px 0; }
        .player-management button { width: 50%; margin: 0; }
        .player-list { display: flex; flex-wrap: wrap; gap: 15px; margin: 15px 0; }
        .player-checkbox { flex: 1 1 45%; display: flex; align-items: center; font-size: 19px; }
        .player-checkbox input { width: auto; margin-right: 12px; height: 24px; accent-color: #d00; }
        .results { margin-top: 30px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .footer-links { text-align: center; margin: 30px 0; }
        .footer-links a { color: #0066cc; margin: 0 15px; text-decoration: underline; font-size: 16px; }
        .popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; }
        .popup-content { background: white; padding: 30px; border-radius: 16px; max-width: 90%; max-height: 85%; overflow-y: auto; }
        .history-entry { padding: 12px 0; border-bottom: 1px solid #eee; font-size: 16px; }
    </style>
</head>
<body>
    <h1>üÉè Big Mike's Big Red Tabulator</h1>
    <div class="subtitle" id="gameSubtitle"></div>

    <div id="setup">
        <label>Game Name (optional)
            <input type="text" id="gameName" placeholder="e.g. New Year's Bash 2026">
        </label>
        <label>Date
            <input type="date" id="gameDate">
        </label>
        <label>How many players? (2‚Äì10)
            <select id="numPlayers">
                <script>
                    for(let i=2; i<=10; i++) document.write(`<option${i===4?' selected':''}>${i}</option>`);
                </script>
            </select>
        </label>
        <button onclick="startNameEntry()">Next</button>
    </div>

    <div id="names" style="display:none;">
        <h2>Enter Player Names</h2>
        <div id="nameInputs"></div>
        <button onclick="startGame()">Start Game</button>
    </div>

    <div id="game" style="display:none;">
        <h2>Enter Data</h2>

        <button class="calc" onclick="showCalculator()">üßÆ Calculate Round Amount</button>

        <label>Winner:
            <select id="winner"></select>
        </label>
        
        <label>Select Losers:</label>
        <div class="player-list" id="losers"></div>
        
        <label>Amount each loser owes the winner:
            <input type="number" step="0.01" min="0" id="amount" placeholder="e.g. 10.00">
        </label>
        
        <button onclick="submitRound()">Submit Round</button>
        <button class="undo" onclick="undoLastRound()" id="undoButton" disabled>Undo Last Round</button>

        <div class="player-management">
            <button class="add" onclick="showAddPlayer()">Add Player</button>
            <button class="remove" onclick="showRemovePlayer()">Remove Player</button>
        </div>

        <div class="results">
            <h3>Current Net Debts</h3>
            <div class="net-debts" id="netDebtList"><p style="text-align:center; color:#888;">Play some rounds to see results!</p></div>

            <h3 style="margin-top:30px;">Overall Settlement</h3>
            <div class="overall" id="overallList"></div>
            <button class="share" onclick="shareResults()">Share Results</button>
        </div>

        <button class="reset" onclick="resetGame()">Reset Entire Game</button>

        <div class="footer-links">
            <a href="#" onclick="showHistory(); return false;">History</a>
            <a href="#" onclick="showStats(); return false;">Stats</a>
        </div>
    </div>

    <!-- History and Stats Popups -->
    <div id="historyPopup" class="popup">
        <div class="popup-content">
            <h2>Round History</h2>
            <div id="historyContent">No rounds yet.</div>
            <button onclick="document.getElementById('historyPopup').style.display='none'" style="background:#999; margin-top:20px;">Close</button>
        </div>
    </div>

    <div id="statsPopup" class="popup">
        <div class="popup-content">
            <h2>Player Stats</h2>
            <div id="statsContent">No data yet.</div>
            <button onclick="document.getElementById('statsPopup').style.display='none'" style="background:#999; margin-top:20px;">Close</button>
        </div>
    </div>

    <script>
        let players = [];
        let debts = {};
        let roundHistory = [];
        let gameName = "";
        let gameDate = "";

        // ... (all your stable functions: startNameEntry, startGame, loadGameScreen, submitRound with vibration, add/remove player, updateResults, saveData, etc.)

        function submitRound() {
            // ... existing validation and debt update ...

            roundHistory.push({
                winner,
                losers: [...losers],
                amount,
                time: new Date().toLocaleTimeString()
            });

            if (navigator.vibrate) navigator.vibrate(50);

            document.getElementById('undoButton').disabled = false;
            // clear form...
            updateResults();
            saveData();
        }

        function undoLastRound() {
            if (roundHistory.length === 0) return;
            const last = roundHistory.pop();
            last.losers.forEach(l => {
                debts[l][last.winner] -= last.amount;
                if (debts[l][last.winner] <= 0.005) debts[l][last.winner] = 0;
            });
            updateResults();
            saveData();
            if (roundHistory.length === 0) document.getElementById('undoButton').disabled = true;
        }

        function showHistory() {
            const content = document.getElementById('historyContent');
            if (roundHistory.length === 0) {
                content.innerHTML = '<p>No rounds played yet.</p>';
            } else {
                content.innerHTML = roundHistory.slice().reverse().map((r, i) => 
                    `<div class="history-entry">
                        <strong>Round ${roundHistory.length - i}</strong> ‚Äî ${r.time}<br>
                        Winner: ${r.winner}<br>
                        Losers: ${r.losers.join(', ')}<br>
                        Amount: $${r.amount.toFixed(2)} each
                    </div>`
                ).join('');
            }
            document.getElementById('historyPopup').style.display = 'flex';
        }

        function showStats() {
            const content = document.getElementById('statsContent');
            const all = [...new Set(Object.keys(debts))];
            let html = '';
            all.forEach(p => {
                let wins = 0, losses = 0, won = 0, lost = 0;
                roundHistory.forEach(r => {
                    if (r.winner === p) { wins++; won += r.amount * r.losers.length; }
                    if (r.losers.includes(p)) { losses++; lost += r.amount; }
                });
                html += `<p><strong>${p}</strong><br>Wins: ${wins} | Losses: ${losses}<br>Won: $${won.toFixed(2)} | Lost: $${lost.toFixed(2)}<br>Net: $${(won-lost).toFixed(2)}</p>`;
            });
            content.innerHTML = html || '<p>No rounds yet.</p>';
            document.getElementById('statsPopup').style.display = 'flex';
        }

        function shareResults() {
            let text = `${gameName || 'Big Red Game'} ‚Äî ${new Date(gameDate || Date.now()).toLocaleDateString()}\n\n`;
            // ... rest of share text ...
        }

        window.onload = () => {
            document.getElementById('gameDate').value = new Date().toISOString().split('T')[0];
            // load saved data including gameName, gameDate, roundHistory
        };
    </script>
</body>
</html>