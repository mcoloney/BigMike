<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My MARFFLE Schedule → .ics Calendar</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; line-height: 1.5; }
    h1 { text-align: center; color: #1a3c6d; }
    .container { background: #f9f9f9; padding: 30px; border-radius: 10px; box-shadow: 0 3px 15px rgba(0,0,0,0.1); text-align: center; }
    input[type="file"] { margin: 20px 0; font-size: 16px; }
    button { padding: 12px 28px; font-size: 17px; background: #1a3c6d; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: #2c55a0; }
    button:disabled { background: #aaa; cursor: not-allowed; }
    #status { margin: 20px 0; font-size: 15px; color: #333; min-height: 1.3em; }
    #pilotName { font-weight: bold; color: #1a3c6d; }
  </style>
</head>
<body>

<div class="container">
  <h1>My March 2026 Schedule → iCalendar (.ics)</h1>

  <p>Upload your personal MARFFLE report HTML file:</p>

  <input type="file" id="htmlFile" accept=".html,.htm" />

  <div id="status">Waiting for file…</div>

  <button id="convertBtn" disabled>Convert & Download .ics</button>
</div>

<script>
const fileInput = document.getElementById('htmlFile');
const convertBtn = document.getElementById('convertBtn');
const status = document.getElementById('status');

let parsedDoc = null;
let pilotName = 'Pilot';

fileInput.addEventListener('change', async () => {
  const file = fileInput.files[0];
  if (!file) return;

  status.textContent = `Reading ${file.name}…`;

  try {
    const text = await file.text();
    const parser = new DOMParser();
    parsedDoc = parser.parseFromString(text, 'text/html');

    // Try to find the pilot name (first cell with comma + numbers)
    const nameCell = Array.from(parsedDoc.querySelectorAll('td')).find(td => {
      const t = td.textContent.trim();
      return t.includes(',') && /\d{3,}/.test(t);
    });

    if (nameCell) {
      pilotName = nameCell.textContent.split('\n')[0].trim().replace(/\s{2,}/g, ' ');
      status.innerHTML = `Detected: <span id="pilotName">${pilotName}</span><br>Ready to convert.`;
    } else {
      status.textContent = 'Could not detect pilot name — but conversion may still work.';
    }

    convertBtn.disabled = false;
  } catch (err) {
    status.textContent = 'Error reading file: ' + err.message;
  }
});

convertBtn.addEventListener('click', () => {
  if (!parsedDoc) {
    status.textContent = 'No file loaded.';
    return;
  }

  const events = extractEvents(parsedDoc);

  if (events.length === 0) {
    status.textContent = 'No schedule events found in the file.';
    return;
  }

  const ics = generateICS(pilotName, events);

  const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${pilotName.replace(/[^a-zA-Z0-9]/g, '_')}_March_2026.ics`;
  a.click();
  URL.revokeObjectURL(url);

  status.textContent = `Downloaded ${events.length} events successfully.`;
});

function extractEvents(doc) {
  const events = [];

  // Find date header row
  const headerRow = Array.from(doc.querySelectorAll('tr')).find(r =>
    r.textContent.includes('Mar') && (r.textContent.includes('02') || r.textContent.includes('WDay'))
  );

  if (!headerRow) return events;

  const dateCells = [];
  let colIdx = 0;
  Array.from(headerRow.children).forEach(cell => {
    const text = cell.textContent.trim();
    const colspan = parseInt(cell.getAttribute('colspan') || '1');
    if (/^\d{1,2} Mar$/.test(text)) {
      dateCells.push({ label: text, colStart: colIdx });
    }
    colIdx += colspan;
  });

  // Find the data row (tall row with events, height around 200px or containing name)
  const dataRow = Array.from(doc.querySelectorAll('tr')).find(r =>
    r.innerHTML.includes(',') || r.style.height?.includes('200') || r.style.height?.includes('201')
  );

  if (!dataRow) return events;

  const cells = Array.from(dataRow.children);

  dateCells.forEach(({ label, colStart }) => {
    const dayMatch = label.match(/^(\d{1,2}) Mar$/);
    if (!dayMatch) return;
    const day = dayMatch[1].padStart(2, '0');
    const ymd = `202603${day}`;

    // Approximate cell location — adjust offset based on your table (often +2–4 after name/spacers)
    const cell = cells[colStart + 3] || cells[colStart + 2] || cells[colStart] || null;
    if (!cell) return;

    let text = cell.textContent.trim().replace(/\s{2,}/g, ' ');
    if (!text) return;

    const timeMatch = text.match(/\b(\d{4})\b/);
    let start, end, isAllDay = !timeMatch;

    if (timeMatch) {
      const t = timeMatch[1];
      const hh = t.slice(0,2);
      const mm = t.slice(2);
      start = `${ymd}T${hh}${mm}00`;
      let eh = (parseInt(hh) + 6) % 24;
      let ed = parseInt(day);
      if (parseInt(hh) + 6 >= 24) ed++;
      end = `202603${ed.toString().padStart(2,'0')}T${eh.toString().padStart(2,'0')}${mm}00`;
    } else {
      start = `VALUE=DATE:${ymd}`;
      end   = `VALUE=DATE:202603${(parseInt(day)+1).toString().padStart(2,'0')}`;
    }

    let summary = text.split('\n')[0].trim();
    if (summary.match(/Sim Day \d+/i)) {
      summary = summary.replace(/B787\s*/i, '').trim();
      if (timeMatch) summary += ` @ ${timeMatch[1]}`;
    }
    summary = summary || label;

    events.push({ summary, start, end, isAllDay });
  });

  return events;
}

function generateICS(name, events) {
  let ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Grok//MARFFLE Personal Schedule//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:${name} - March 2026
X-WR-TIMEZONE:America/Chicago
`;

  events.forEach(ev => {
    const uid = Date.now() + '-' + Math.random().toString(36).slice(2, 8) + '@marffle';
    ics += `BEGIN:VEVENT
UID:${uid}
DTSTAMP:${new Date().toISOString().replace(/[-:T.]/g,'').slice(0,14)}Z
SUMMARY:${ev.summary.replace(/,/g,'\\,').replace(/;/g,'\\;')}
${ev.isAllDay 
  ? `DTSTART;${ev.start}\nDTEND;${ev.end}`
  : `DTSTART;TZID=America/Chicago:${ev.start}\nDTEND;TZID=America/Chicago:${ev.end}`}
END:VEVENT
`;
  });

  ics += 'END:VCALENDAR\n';
  return ics;
}
</script>

</body>
</html>