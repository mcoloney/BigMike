<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Red Score Tracker</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="data:application/manifest+json,{
        'name': 'Big Mike's Big Red Tabulator',
        'short_name': 'BigRed',
        'start_url': '.',
        'display': 'standalone',
        'background_color': '#ff0000',
        'theme_color': '#ff0000',
        'icons': [{'src': 'https://via.placeholder.com/192x192.png?text=üÉè', 'sizes': '192x192', 'type': 'image/png'}]
    }">
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f9f9f9; color: #333; max-width: 600px; margin: auto; line-height: 1.5; min-height: 100vh; }
        h1 { text-align: center; color: #d00; margin: 10px 0 5px; font-size: 24px; font-weight: bold; }
        .subtitle { text-align: center; font-size: 17px; color: #555; margin-bottom: 25px; font-style: italic; }
        h2 { color: #333; font-size: 20px; margin: 20px 0 10px; }
        h3 { color: #333; }
        input, select { padding: 14px; margin: 12px 0; width: 100%; font-size: 18px; box-sizing: border-box; border-radius: 8px; border: 1px solid #ccc; background: white; color: #333; }
        button { padding: 14px; margin: 12px 0; width: 100%; font-size: 18px; box-sizing: border-box; border-radius: 8px; border: none; font-weight: bold; min-height: 56px; color: white; cursor: pointer; }
        button:disabled { background: #aaa; cursor: not-allowed; opacity: 0.6; }
        button.add { background: #0066cc; }
        button.calc { background: #ff6b00; font-size: 20px; padding: 16px; }
        button.remove { background: #cc0000; }
        button.share { background: #00cc66; }
        button.reset { background: #666; }
        button.undo { background: #888; }
        .player-management { display: flex; gap: 12px; margin: 12px 0; }
        .player-management button { width: 50%; margin: 0; }
        .player-list { display: flex; flex-wrap: wrap; gap: 15px; margin: 15px 0; }
        .player-checkbox { flex: 1 1 45%; display: flex; align-items: center; font-size: 19px; }
        .player-checkbox input { width: auto; margin-right: 12px; height: 24px; accent-color: #d00; }
        .results { margin-top: 30px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .net-debts p { margin: 16px 0; font-size: 19px; }
        .net-debts p strong { color: #d00; }
        .overall ul { margin: 15px 0 0 0; padding-left: 25px; }
        .overall li { margin: 12px 0; font-size: 19px; }
        .positive { color: #0a0; font-weight: bold; }
        .negative { color: #d00; font-weight: bold; }
        .zero { color: #666; }
        /* Popup styles */
        #calcSection > div, #addPlayerSection > div, #removePlayerSection > div { background: white; }
    </style>
</head>
<body>
    <h1>üÉè Big Mike's Big Red Tabulator</h1>
    <div class="subtitle" id="gameSubtitle"></div>

    <div id="setup">
        <label>Game Name (optional)
            <input type="text" id="gameName" placeholder="e.g. New Year's Game 2026">
        </label>
        <label>Date
            <input type="date" id="gameDate">
        </label>
        <label>How many players? (2‚Äì10)
            <select id="numPlayers">
                <script>
                    for(let i=2; i<=10; i++) document.write(`<option${i===4?' selected':''}>${i}</option>`);
                </script>
            </select>
        </label>
        <button onclick="startNameEntry()">Next</button>
    </div>

    <div id="names" style="display:none;">
        <h2>Enter Player Names</h2>
        <div id="nameInputs"></div>
        <button onclick="startGame()">Start Game</button>
    </div>

    <div id="game" style="display:none;">
        <h2>Enter Data</h2>

        <button class="calc" onclick="showCalculator()">üßÆ Calculate Round Amount</button>

        <label>Winner:
            <select id="winner"></select>
        </label>
        
        <label>Select Losers:</label>
        <div class="player-list" id="losers"></div>
        
        <label>Amount each loser owes the winner:
            <input type="number" step="0.01" min="0" id="amount" placeholder="e.g. 10.00">
        </label>
        
        <button onclick="submitRound()">Submit Round</button>
        <button class="undo" id="undoButton" onclick="undoLastRound()" disabled>Undo Last Round</button>

        <div class="player-management">
            <button class="add" onclick="showAddPlayer()">Add Player</button>
            <button class="remove" onclick="showRemovePlayer()">Remove Player</button>
        </div>

        <div class="results">
            <h3>Current Net Debts</h3>
            <div class="net-debts" id="netDebtList">
                <p style="text-align:center; color:#888;">Play some rounds to see results!</p>
            </div>

            <h3 style="margin-top:30px;">Overall Settlement</h3>
            <div class="overall" id="overallList"></div>
            <button class="share" onclick="shareResults()">Share Results</button>
        </div>

        <button class="reset" onclick="resetGame()">Reset Entire Game</button>
    </div>

    <!-- Calculator, Add, Remove popups unchanged -->

    <script>
        let players = [];
        let debts = {};
        let roundHistory = []; // Simple stack for undo: {winner, losers[], amount}
        let gameName = "";
        let gameDate = "";

        function startNameEntry() {
            gameName = document.getElementById('gameName').value.trim();
            gameDate = document.getElementById('gameDate').value;
            const num = parseInt(document.getElementById('numPlayers').value);
            const container = document.getElementById('nameInputs');
            container.innerHTML = '';
            for(let i=0; i<num; i++) {
                container.innerHTML += `<input type="text" placeholder="Player ${i+1} name" id="name${i}">`;
            }
            document.getElementById('setup').style.display = 'none';
            document.getElementById('names').style.display = 'block';
        }

        function startGame() {
            if (!gameName) gameName = "Big Red Game";
            if (!gameDate) gameDate = new Date().toISOString().split('T')[0];

            const num = document.querySelectorAll('#nameInputs input').length;
            players = [];
            for(let i=0; i<num; i++) {
                const name = document.getElementById(`name${i}`).value.trim();
                if(!name) return alert('Please enter all player names!');
                if(players.includes(name)) return alert('Duplicate names not allowed!');
                players.push(name);
            }
            initializeDebts();
            updateSubtitle();
            document.getElementById('names').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            loadGameScreen();
            saveData();
        }

        function updateSubtitle() {
            const sub = document.getElementById('gameSubtitle');
            const dateObj = new Date(gameDate);
            const formattedDate = dateObj.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            sub.textContent = `${gameName} ‚Äî ${formattedDate}`;
        }

        function initializeDebts() {
            debts = {};
            players.forEach(p => {
                debts[p] = {};
                players.forEach(o => { if (o !== p) debts[p][o] = 0; });
            });
        }

        function loadGameScreen() {
            const winnerSel = document.getElementById('winner');
            winnerSel.innerHTML = '<option value="">Pick winner</option>';
            players.forEach(p => winnerSel.innerHTML += `<option value="${p}">${p}</option>`);

            const losersDiv = document.getElementById('losers');
            losersDiv.innerHTML = '';
            players.forEach(p => {
                losersDiv.innerHTML += `<label class="player-checkbox"><input type="checkbox" value="${p}"> ${p}</label>`;
            });

            winnerSel.onchange = () => {
                const winner = winnerSel.value;
                document.querySelectorAll('#losers input').forEach(cb => {
                    cb.disabled = (cb.value === winner);
                    if (cb.value === winner) cb.checked = false;
                });
            };

            updateResults();
        }

        function submitRound() {
            const winner = document.getElementById('winner').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const losers = Array.from(document.querySelectorAll('#losers input:checked'))
                            .map(cb => cb.value)
                            .filter(l => l !== winner);

            if (!winner) return alert('Select a winner!');
            if (losers.length === 0) return alert('Select at least one loser!');
            if (isNaN(amount) || amount <= 0) return alert('Enter a valid amount greater than 0!');

            // Record for undo
            roundHistory.push({winner, losers: [...losers], amount});

            losers.forEach(loser => {
                debts[loser][winner] = (debts[loser][winner] || 0) + amount;
            });

            document.getElementById('winner').value = '';
            document.getElementById('amount').value = '';
            document.querySelectorAll('#losers input').forEach(cb => {
                cb.checked = false;
                cb.disabled = false;
            });

            document.getElementById('undoButton').disabled = false;

            updateResults();
            saveData();
        }

        function undoLastRound() {
            if (roundHistory.length === 0) return;
            const last = roundHistory.pop();
            last.losers.forEach(loser => {
                debts[loser][last.winner] = (debts[loser][last.winner] || 0) - last.amount;
                if (debts[loser][last.winner] <= 0.005) delete debts[loser][last.winner];
            });
            updateResults();
            saveData();
            if (roundHistory.length === 0) document.getElementById('undoButton').disabled = true;
        }

        // All other functions (showCalculator, addNewPlayer, removePlayer, shareResults, updateResults, resetGame, saveData, onload) are exactly the same as Version 1.1

        function shareResults() {
            const dateObj = new Date(gameDate);
            const formattedDate = dateObj.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            let shareText = `${gameName} ‚Äî ${formattedDate}\n\nCurrent Net Debts:\n`;
            const netDebtDiv = document.getElementById('netDebtList');
            if (netDebtDiv.innerText.includes('settled')) {
                shareText += "All debts are settled! üéâ\n";
            } else {
                Array.from(netDebtDiv.querySelectorAll('p')).forEach(p => shareText += p.innerText + "\n");
            }
            shareText += "\nOverall Settlement:\n";
            Array.from(document.getElementById('overallList').querySelectorAll('li')).forEach(li => shareText += li.innerText + "\n");

            if (navigator.share) {
                navigator.share({ text: shareText }).catch(() => {});
            } else {
                const ta = document.createElement('textarea');
                ta.value = shareText;
                ta.style.position = 'fixed'; ta.style.opacity = 0;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                alert('Results copied to clipboard! Paste to share.');
            }
        }

        function updateResults() {
            // Identical to Version 1.1 ‚Äì full net debt & settlement calculation
            const netDebtDiv = document.getElementById('netDebtList');
            const overallDiv = document.getElementById('overallList');
            const allParticipants = [...new Set(Object.keys(debts))].sort((a,b) => a.localeCompare(b));

            let netLines = [];
            for (let i = 0; i < allParticipants.length; i++) {
                for (let j = i + 1; j < allParticipants.length; j++) {
                    const p1 = allParticipants[i];
                    const p2 = allParticipants[j];
                    const owesP1toP2 = (debts[p1]?.[p2]) || 0;
                    const owesP2toP1 = (debts[p2]?.[p1]) || 0;
                    const net = owesP1toP2 - owesP2toP1;
                    if (Math.abs(net) > 0.005) {
                        net > 0 ?
                            netLines.push(`<strong>${p1}</strong> owes <strong>${p2}</strong> $${net.toFixed(2)}`) :
                            netLines.push(`<strong>${p2}</strong> owes <strong>${p1}</strong> $${(-net).toFixed(2)}`);
                    }
                }
            }

            if (netLines.length === 0) {
                netDebtDiv.innerHTML = `<p style="text-align:center; font-size:20px; color:#090;">All debts are settled! üéâ</p>`;
            } else {
                netDebtDiv.innerHTML = netLines.map(line => `<p>${line}</p>`).join('');
            }

            let balances = {};
            allParticipants.forEach(p => balances[p] = 0);
            allParticipants.forEach(payer => {
                Object.entries(debts[payer] || {}).forEach(([payee, amt]) => {
                    if (amt > 0.005) {
                        balances[payer] -= amt;
                        balances[payee] += amt;
                    }
                });
            });

            const sortedBalances = Object.entries(balances)
                .map(([name, bal]) => ({name, bal: Math.round(bal * 100)/100}))
                .sort((a,b) => b.bal - a.bal);

            let overallHtml = '<ul>';
            sortedBalances.forEach(({name, bal}) => {
                let text, cls;
                if (bal > 0.005) { text = `${name} is owed $${bal.toFixed(2)} overall`; cls = 'positive'; }
                else if (bal < -0.005) { text = `${name} owes $${(-bal).toFixed(2)} overall`; cls = 'negative'; }
                else { text = `${name} is even`; cls = 'zero'; }
                overallHtml += `<li class="${cls}">${text}</li>`;
            });
            overallHtml += '</ul>';
            overallDiv.innerHTML = overallHtml;
        }

        function saveData() {
            localStorage.setItem('bigredData', JSON.stringify({players, debts, gameName, gameDate, roundHistory}));
        }

        window.onload = () => {
            document.getElementById('gameDate').value = new Date().toISOString().split('T')[0];
            const saved = localStorage.getItem('bigredData');
            if (saved) {
                const data = JSON.parse(saved);
                players = data.players || [];
                debts = data.debts || {};
                gameName = data.gameName || "";
                gameDate = data.gameDate || new Date().toISOString().split('T')[0];
                roundHistory = data.roundHistory || [];
                if (players.length > 0) {
                    document.getElementById('setup').style.display = 'none';
                    document.getElementById('game').style.display = 'block';
                    updateSubtitle();
                    loadGameScreen();
                    if (roundHistory.length > 0) document.getElementById('undoButton').disabled = false;
                }
            }
        };
    </script>
</body>
</html>