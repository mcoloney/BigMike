<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big Red Score Tracker</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="data:application/manifest+json,{
        'name': 'Big Mike's Big Red Tabulator',
        'short_name': 'BigRed',
        'start_url': '.',
        'display': 'standalone',
        'background_color': '#ff0000',
        'theme_color': '#ff0000',
        'icons': [{'src': 'https://via.placeholder.com/192x192.png?text=üÉè', 'sizes': '192x192', 'type': 'image/png'}]
    }">
    <style>
        body { font-family: -apple-system, sans-serif; padding: 20px; background: #f9f9f9; color: #333; max-width: 600px; margin: auto; line-height: 1.5; min-height: 100vh; }
        h1 { text-align: center; color: #d00; margin: 10px 0 5px; font-size: 24px; font-weight: bold; }
        .game-subtitle { text-align: center; font-size: 16px; color: #666; margin-bottom: 20px; font-style: italic; }
        h2 { color: #333; font-size: 20px; margin: 20px 0 10px; }
        h3 { color: #333; }
        input, select { padding: 14px; margin: 12px 0; width: 100%; font-size: 18px; box-sizing: border-box; border-radius: 8px; border: 1px solid #ccc; background: white; }
        button { padding: 14px; margin: 12px 0; width: 100%; font-size: 18px; box-sizing: border-box; border-radius: 8px; border: none; font-weight: bold; min-height: 56px; color: white; cursor: pointer; }
        button:disabled { background: #ccc; }
        button.calc { background: #ff6b00; font-size: 20px; padding: 16px; }
        button.undo { background: #888; }
        button.share { background: #00cc66; }
        button.reset { background: #666; }
        .player-management { display: flex; gap: 12px; margin: 12px 0; }
        .player-management button { width: 50%; margin: 0; }
        .player-list { display: flex; flex-wrap: wrap; gap: 15px; margin: 15px 0; }
        .player-checkbox { flex: 1 1 45%; display: flex; align-items: center; font-size: 19px; }
        .player-checkbox input { width: auto; margin-right: 12px; height: 24px; accent-color: #d00; }
        .results { margin-top: 30px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .net-debts p { margin: 16px 0; font-size: 19px; }
        .net-debts p strong { color: #d00; }
        .overall ul { margin: 15px 0 0 0; padding-left: 25px; }
        .overall li { margin: 12px 0; font-size: 19px; }
        .positive { color: #0a0; font-weight: bold; }
        .negative { color: #d00; font-weight: bold; }
        .zero { color: #666; }
        .footer-links { text-align: center; margin: 30px 0 10px; font-size: 15px; }
        .footer-links a { color: #0066cc; text-decoration: underline; margin: 0 15px; }
        /* Popups */
        .popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; justify-content: center; align-items: center; }
        .popup-content { background: white; padding: 25px; border-radius: 16px; max-width: 90%; max-height: 80%; overflow-y: auto; }
        .popup-content h2 { margin-top: 0; text-align: center; }
        .round-log { font-size: 16px; }
        .round-log div { padding: 10px; border-bottom: 1px solid #eee; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 16px; }
        .stats-grid div { padding: 8px; background: #f0f0f0; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>üÉè Big Mike's Big Red Tabulator</h1>
    <div class="game-subtitle" id="gameHeader"></div>
    
    <div id="setup">
        <label>Game Name (optional)
            <input type="text" id="gameName" placeholder="e.g. New Year's Game 2026">
        </label>
        <label>Date
            <input type="date" id="gameDate">
        </label>
        <label>How many players? (2‚Äì10)
            <select id="numPlayers">
                <script>
                    for(let i=2; i<=10; i++) document.write(`<option${i===4?' selected':''}>${i}</option>`);
                </script>
            </select>
        </label>
        <button onclick="startNameEntry()">Next</button>
    </div>

    <div id="names" style="display:none;">
        <h2>Enter Player Names</h2>
        <div id="nameInputs"></div>
        <button onclick="startGame()">Start Game</button>
    </div>

    <div id="game" style="display:none;">
        <h2>Enter Data</h2>

        <button class="calc" onclick="showCalculator()">üßÆ Calculate Round Amount</button>

        <label>Winner:
            <select id="winner"></select>
        </label>
        
        <label>Select Losers:</label>
        <div class="player-list" id="losers"></div>
        
        <label>Amount each loser owes the winner:
            <input type="number" step="0.01" min="0" id="amount" placeholder="e.g. 10.00">
        </label>
        
        <button onclick="submitRound()">Submit Round</button>
        <button class="undo" onclick="undoLastRound()" id="undoBtn" disabled>Undo Last Round</button>

        <div class="player-management">
            <button onclick="showAddPlayer()">Add Player</button>
            <button class="remove" onclick="showRemovePlayer()">Remove Player</button>
        </div>

        <div class="results">
            <h3>Current Net Debts</h3>
            <div class="net-debts" id="netDebtList">
                <p style="text-align:center; color:#888;">Play some rounds to see results!</p>
            </div>

            <h3 style="margin-top:30px;">Overall Settlement</h3>
            <div class="overall" id="overallList"></div>
            <button class="share" onclick="shareResults()">Share Results</button>
        </div>

        <button class="reset" onclick="resetGame()">Reset Entire Game</button>

        <div class="footer-links">
            <a href="#" onclick="showHistory(); return false;">History</a>
            <a href="#" onclick="showStats(); return false;">Stats</a>
        </div>
    </div>

    <!-- Popups -->
    <div id="calcSection" class="popup"><div class="popup-content"> <!-- same as before --> </div></div>
    <div id="addPlayerSection" class="popup"><div class="popup-content"> <!-- same --> </div></div>
    <div id="removePlayerSection" class="popup"><div class="popup-content"> <!-- same --> </div></div>

    <!-- History Popup -->
    <div id="historyPopup" class="popup">
        <div class="popup-content">
            <h2>Round History</h2>
            <div id="historyLog" class="round-log">No rounds yet.</div>
            <button onclick="hidePopup('historyPopup')" style="background:#999; margin-top:20px;">Close</button>
        </div>
    </div>

    <!-- Stats Popup -->
    <div id="statsPopup" class="popup">
        <div class="popup-content">
            <h2>Player Stats</h2>
            <div id="statsContent">No data yet.</div>
            <button onclick="hidePopup('statsPopup')" style="background:#999; margin-top:20px;">Close</button>
        </div>
    </div>

    <script>
        let players = [];
        let debts = {};
        let gameName = "";
        let gameDate = "";
        let roundHistory = []; // {winner, losers: [], amount, timestamp}

        function startNameEntry() {
            const num = parseInt(document.getElementById('numPlayers').value);
            document.getElementById('gameName').value = document.getElementById('gameName').value.trim();
            gameDate = document.getElementById('gameDate').value || new Date().toISOString().split('T')[0];
            const container = document.getElementById('nameInputs');
            container.innerHTML = '';
            for(let i=0; i<num; i++) {
                container.innerHTML += `<input type="text" placeholder="Player ${i+1} name" id="name${i}">`;
            }
            document.getElementById('setup').style.display = 'none';
            document.getElementById('names').style.display = 'block';
        }

        function startGame() {
            gameName = document.getElementById('gameName').value.trim() || "Big Red Game";
            const num = document.querySelectorAll('#nameInputs input').length;
            players = [];
            for(let i=0; i<num; i++) {
                const name = document.getElementById(`name${i}`).value.trim();
                if(!name) return alert('Please enter all player names!');
                if(players.includes(name)) return alert('Duplicate names not allowed!');
                players.push(name);
            }
            initializeDebts();
            updateGameHeader();
            document.getElementById('names').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            loadGameScreen();
            saveData();
        }

        function updateGameHeader() {
            const header = document.getElementById('gameHeader');
            const dateStr = new Date(gameDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            header.textContent = `${gameName} ‚Äî ${dateStr}`;
        }

        // ... (initializeDebts, loadGameScreen, updateResults same as before)

        function submitRound() {
            const winner = document.getElementById('winner').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const losers = Array.from(document.querySelectorAll('#losers input:checked'))
                            .map(cb => cb.value)
                            .filter(l => l !== winner);

            if (!winner || losers.length === 0 || isNaN(amount) || amount <= 0) {
                alert('Please fill in winner, losers, and valid amount!');
                return;
            }

            // Record round
            roundHistory.push({
                winner,
                losers: [...losers],
                amount,
                timestamp: new Date().toLocaleTimeString()
            });

            // Apply debts
            losers.forEach(loser => {
                debts[loser][winner] += amount;
            });

            if (navigator.vibrate) navigator.vibrate(50);

            document.getElementById('winner').value = '';
            document.getElementById('amount').value = '';
            document.querySelectorAll('#losers input').forEach(cb => {
                cb.checked = false;
                cb.disabled = false;
            });

            document.getElementById('undoBtn').disabled = false;

            updateResults();
            saveData();
        }

        function undoLastRound() {
            if (roundHistory.length === 0) return;
            const last = roundHistory.pop();
            last.losers.forEach(loser => {
                debts[loser][last.winner] -= last.amount;
                if (debts[loser][last.winner] <= 0.005) delete debts[loser][last.winner];
            });
            updateResults();
            saveData();
            if (roundHistory.length === 0) document.getElementById('undoBtn').disabled = true;
        }

        function showHistory() {
            const log = document.getElementById('historyLog');
            if (roundHistory.length === 0) {
                log.innerHTML = '<div>No rounds yet.</div>';
            } else {
                log.innerHTML = roundHistory.slice().reverse().map((r, i) => 
                    `<div><strong>Round ${roundHistory.length - i}:</strong> ${r.timestamp}<br>
                    Winner: ${r.winner}<br>
                    Losers: ${r.losers.join(', ')}<br>
                    Amount each: $${r.amount.toFixed(2)}</div>`
                ).join('');
            }
            document.getElementById('historyPopup').style.display = 'flex';
        }

        function showStats() {
            const content = document.getElementById('statsContent');
            if (players.length === 0) {
                content.innerHTML = 'No players yet.';
                document.getElementById('statsPopup').style.display = 'flex';
                return;
            }
            let statsHtml = '<div class="stats-grid">';
            const allPlayers = [...new Set(Object.keys(debts))];
            allPlayers.forEach(p => {
                let wins = 0, losses = 0, won = 0, lost = 0;
                roundHistory.forEach(r => {
                    if (r.winner === p) { wins++; won += r.amount * r.losers.length; }
                    if (r.losers.includes(p)) { losses++; lost += r.amount; }
                });
                const net = won - lost;
                statsHtml += `
                    <div><strong>${p}</strong></div>
                    <div>W: ${wins} L: ${losses}<br>+$${won.toFixed(2)} -$${lost.toFixed(2)}<br>Net: $${net.toFixed(2)}</div>`;
            });
            statsHtml += '</div>';
            content.innerHTML = statsHtml;
            document.getElementById('statsPopup').style.display = 'flex';
        }

        function hidePopup(id) {
            document.getElementById(id).style.display = 'none';
        }

        function shareResults() {
            let text = `${gameName} ‚Äî ${new Date(gameDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n\n`;
            text += "Current Net Debts:\n";
            const netDebtDiv = document.getElementById('netDebtList');
            if (netDebtDiv.innerText.includes('settled')) {
                text += "All debts are settled! üéâ\n";
            } else {
                Array.from(netDebtDiv.querySelectorAll('p')).forEach(p => text += p.innerText + "\n");
            }
            text += "\nOverall Settlement:\n";
            Array.from(document.getElementById('overallList').querySelectorAll('li')).forEach(li => text += li.innerText + "\n");
            if (navigator.share) {
                navigator.share({ text }).catch(() => {});
            } else {
                navigator.clipboard.writeText(text).then(() => alert('Copied to clipboard!'));
            }
        }

        // ... (rest of functions: calculator, add/remove player, reset, save/load)

        window.onload = () => {
            document.getElementById('gameDate').value = new Date().toISOString().split('T')[0];
            const saved = localStorage.getItem('bigredData');
            if (saved) {
                const data = JSON.parse(saved);
                players = data.players || [];
                debts = data.debts || {};
                gameName = data.gameName || "Big Red Game";
                gameDate = data.gameDate || new Date().toISOString().split('T')[0];
                roundHistory = data.roundHistory || [];
                if (players.length > 0) {
                    document.getElementById('setup').style.display = 'none';
                    document.getElementById('game').style.display = 'block';
                    updateGameHeader();
                    loadGameScreen();
                    if (roundHistory.length > 0) document.getElementById('undoBtn').disabled = false;
                }
            }
        };

        function saveData() {
            localStorage.setItem('bigredData', JSON.stringify({
                players, debts, gameName, gameDate, roundHistory
            }));
        }
    </script>
</body>
</html>